const CHUNK_SIZE=50,HOME_KEYWORDS=["Home","Trang chủ","/"],MAX_LEVELS=5,elements={pasteBtn:document.getElementById("pasteButton"),downSitemapBtn:document.getElementById("downSitemap"),clearBtn:document.getElementById("clear"),urlInput:document.getElementById("urlInput"),copyTableBtn:document.getElementById("copyTableBtn"),exportCsvBtn:document.getElementById("exportCsvBtn"),retryBtn:document.getElementById("retryError"),progress:document.querySelector(".detail-handle .progress"),cout:document.querySelector(".detail-handle .cout"),time:document.querySelector(".detail-handle .time"),averageSpend:document.querySelector(".detail-handle .average-spend"),err:document.querySelector(".detail-handle .err")},appState={hasData:!1,isProcessing:!1,successUrls:[],errorUrls:[],currentProxy:0,proxyList:["https://cors.eu.org/","https://api.allorigins.win/raw?url=","https://api.codetabs.com/v1/proxy?quest="]},statsState={startTime:0,endTime:0,totalUrls:0,processedUrls:0},errorResult={type:"Lỗi kết nối",id:"",cmsLink:"",title:"Lỗi kết nối",metaDescription:"Lỗi kết nối",level1:"",level2:"",level3:"",level4:"",level5:""},toast={container:null,queue:[],timeoutId:null,activeToasts:{},init(){this.container||(this.container=document.createElement("div"),this.container.className="toast-container",document.body.appendChild(this.container))},show(t,e="info",n=3500){this.init();const r=document.createElement("div");r.className=`toast toast-${e}`,r.textContent=t,this.queue.push({element:r,duration:n}),this.processQueue()},showWithId(t,e="info",n=3500,r){this.init();const o=document.createElement("div");o.className=`toast toast-${e}`,o.textContent=t,o.id=r,this.activeToasts[r]=o,this.container.appendChild(o),setTimeout((()=>o.classList.add("show")),10),n>0&&setTimeout((()=>{this.hide(r)}),n)},updateMessage(t,e){this.activeToasts[t]&&(this.activeToasts[t].textContent=e)},hide(t){if(this.activeToasts[t]){const e=this.activeToasts[t];e.classList.remove("show"),setTimeout((()=>{e.remove(),delete this.activeToasts[t]}),300)}},processQueue(){if(this.timeoutId||0===this.queue.length)return;const{element:t,duration:e}=this.queue.shift();this.container.appendChild(t),setTimeout((()=>t.classList.add("show")),10),this.timeoutId=setTimeout((()=>{t.classList.remove("show"),setTimeout((()=>{t.remove(),this.timeoutId=null,this.processQueue()}),300)}),e)}};function formatTime(t){if(t<60)return`${t} giây`;const e=Math.floor(t/86400);t%=86400;const n=Math.floor(t/3600);t%=3600;const r=Math.floor(t/60);let o="";return e>0&&(o+=`${e} ngày `),n>0&&(o+=`${n} giờ `),r>0&&(o+=`${r} phút `),((t=Math.floor(t%60))>0||""===o)&&(o+=`${t} giây`),o.trim()}function updateStats(){const t=Date.now(),e=0==statsState.startTime?"0":(t-statsState.startTime)/1e3,n=0==statsState.processedUrls?"0":Math.ceil(statsState.processedUrls/e);elements.progress.textContent=`${statsState.processedUrls}/${statsState.totalUrls}`,elements.cout.textContent=statsState.totalUrls,elements.time.textContent=formatTime(e),elements.averageSpend.textContent=n,elements.err.textContent=appState.errorUrls.length}const toggleButtons={pasteButton:()=>{const t=!!elements.urlInput.value.trim();elements.pasteBtn.style.display=t?"none":"block",elements.downSitemapBtn.style.display=t?"none":"block",elements.clearBtn.style.display=t?"block":"none",elements.cout.textContent=t?urlInput.value.split("\n").filter((t=>t.trim())).length:0},actionButtons:t=>{[elements.copyTableBtn,elements.exportCsvBtn,elements.clearBtn].forEach((e=>{e&&(e.style.display=t?"block":"none")})),elements.retryBtn&&(elements.retryBtn.style.display=t&&appState.errorUrls.length>0?"block":"none")},init:()=>{toggleButtons.actionButtons(!1),toggleButtons.pasteButton()}};function validateAndProcessInput(t){return t.split("\n").map((t=>t.trim())).filter((t=>t.match(/^(https?:\/\/[^\s]+)/)))}async function pasteFromClipboard(){try{const t=await navigator.clipboard.readText();elements.urlInput.value=validateAndProcessInput(t).join("\n"),toggleButtons.pasteButton()}catch(t){toast.show(`Không thể dán:  ${t}`,"error")}}function copyColumn(t){const e=document.getElementById("resultTable"),n=Array.from(e.rows).slice(1).map((e=>e.cells[t].textContent.trim())).join("\n");navigator.clipboard.writeText(n).then((()=>{const n=e.querySelector(`th:nth-child(${t+1})`).querySelector("button"),r=n.textContent,o=n.style.cssText;n.textContent="Copied!",n.style.backgroundColor="#90EE90",n.style.borderColor="#4CAF50",setTimeout((()=>{n.textContent=r,n.style.cssText=o}),1e3)})).catch((t=>toast.show(`Không thể copy:  ${t}`,"error")))}function updateTableHeaders(){if(!appState.hasData)return;const t=document.querySelector("#resultTable thead tr");if(t.querySelector("button"))return;const e=document.querySelector("#resultTable tbody"),n=Array.from(e.rows);Array.from(t.cells).slice(1).forEach(((t,e)=>{const r=e+1;if(n.some((t=>{const e=t.cells[r].textContent.trim();return e&&"Lỗi"!==e&&"Không xác định"!==e&&"Không thể tạo link CMS"!==e}))){const e=document.createElement("button");e.textContent="Copy",e.style.cssText="\n                margin-left: .5rem;\n                cursor: pointer;\n                background: #f0f0f0;\n                border: 1px solid #ddd;\n                border-radius: 3px;\n                padding: 2px 6px;\n                font-size: 12px;\n                opacity: 0.8;\n                transition: all 0.2s ease;\n            ",e.onmouseover=()=>{e.style.opacity="1",e.style.backgroundColor="#e0e0e0"},e.onmouseout=()=>{e.style.opacity="0.8",e.style.backgroundColor="#f0f0f0"},e.onclick=t=>{t.stopPropagation(),copyColumn(r)},t.appendChild(e)}}))}function copyTable(){const t=document.getElementById("resultTable"),e=Array.from(t.rows).map((t=>Array.from(t.cells).map((t=>t.querySelector("button")?getCleanHeaderText(t):t.textContent.trim())).join("\t"))).join("\n");navigator.clipboard.writeText(e).then((()=>{const e=t.querySelector("tbody");e.style.backgroundColor="#61ff5540",setTimeout((()=>e.style.backgroundColor=""),700)}))}function downloadFile(t,e,n){const r=new Blob([t],{type:n}),o=document.createElement("a");o.href=window.URL.createObjectURL(r),o.download=e,o.click()}function getCleanHeaderText(t){const e=document.createElement("div");e.innerHTML=t.innerHTML;const n=e.querySelector("button");return n&&n.remove(),e.textContent.trim()}function encodeToUTF8(t){return(new TextEncoder).encode("\ufeff"+t)}function exportCSV(){const t=document.getElementById("resultTable"),e=Array.from(t.rows),n=Array.from(e[0].cells).map((t=>getCleanHeaderText(t))),r=e.slice(1).map((t=>Array.from(t.cells).map((t=>`"${t.textContent.trim().replace(/"/g,'""')}"`)))),o=[n.join(","),...r.map((t=>t.join(",")))].join("\n"),a=new Blob([encodeToUTF8(o)],{type:"text/csv;charset=utf-8"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download="url-info-export.csv",s.click()}elements.urlInput.addEventListener("input",(function(){this.value=validateAndProcessInput(this.value).join("\n"),toggleButtons.pasteButton()}));const timeoutPromise=(t,e=3e4)=>Promise.race([t,new Promise(((t,n)=>setTimeout((()=>n(new Error("Request timeout"))),e)))]),urlCache=new Map;async function getUrlInfo(t,e=0){if(urlCache.has(t))return urlCache.get(t);const n=appState.proxyList[appState.currentProxy]+encodeURIComponent(t);try{const e=await timeoutPromise(fetch(n));if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const r=await e.text(),o=(new DOMParser).parseFromString(r,"text/html");let{id:a,type:s,blogId:l,deft:i}=getIdSiteHaravan(o);const c=extractBreadcrumbCategories(s,o),u={id:a,type:s,title:o.querySelector("title")?.textContent||"",metaDescription:o.querySelector('meta[name="description"]')?.getAttribute("content")||"",cmsLink:getCmsLink(t,a,s,l,i),...c};appState.successUrls.includes(t)||appState.successUrls.push(t);const d=appState.errorUrls.indexOf(t);return d>-1&&appState.errorUrls.splice(d,1),urlCache.set(t,u),u}catch(n){return e<3?(appState.currentProxy=(appState.currentProxy+1)%appState.proxyList.length,await new Promise((t=>setTimeout(t,2e3*(e+1)))),getUrlInfo(t,e+1)):(appState.errorUrls.includes(t)||appState.errorUrls.push(t),urlCache.set(t,errorResult),errorResult)}}function clearData(){const t=document.querySelector("#resultTable tbody");elements.urlInput.value="",t.innerHTML="";document.querySelectorAll("#resultTable thead button").forEach((t=>t.remove())),appState.hasData=!1,appState.successUrls=[],appState.errorUrls=[],appState.currentProxy=0,statsState.startTime=0,statsState.endTime=0,statsState.totalUrls=0,statsState.processedUrls=0,updateStats(),toggleButtons.actionButtons(!1),toggleButtons.pasteButton(),urlCache.clear(),toast.show("Đã làm mới dữ liệu","success")}function updateButtonStates(){appState.hasData?(elements.clearBtn.style.display="block",elements.copyTableBtn.style.display="block",elements.exportCsvBtn.style.display="block",elements.retryBtn.style.display=appState.errorUrls.length>0?"block":"none"):(elements.clearBtn.style.display="none",elements.copyTableBtn.style.display="none",elements.exportCsvBtn.style.display="none",elements.retryBtn.style.display="none")}function checkForErrors(){const t=document.querySelectorAll("#resultTable tbody tr.error");appState.errorUrls=Array.from(t).map((t=>t.querySelector("td:nth-child(2) a").href)),updateButtonStates()}function getIdSiteHaravan(t){let e=null,n=null,r=null,o=!1;try{const a=t.querySelectorAll("script");for(const t of a){const r=t.textContent||"";if(r.includes("HaravanAnalytics")&&r.includes("meta")){const t=r.match(/var\s+meta\s*=\s*(\{[\s\S]*?\});/);if(t&&t[1]){const r=t[1].replace(/'/g,'"');try{const t=JSON.parse(r);t.page&&(e=t.page.resourceId||null,t.page.resourceType?n=t.page.resourceType.toLowerCase():t.page.pageType&&(n=t.page.pageType.toLowerCase()))}catch(t){console.error("Không thể parse JSON từ script meta:",t)}}}}for(const t of a){const r=t.textContent||"";if(r.includes("Haravan.theme")){const t=r.match(/Haravan\.theme\s*=\s*(\{[^;]*\})/);if(t&&t[1])try{if("home"===n||"blog"===n&&null===e||"collection"===n&&null===e){const n=t[1].match(/"id"\s*:\s*(\d+)/);n&&n[1]&&(e=parseInt(n[1]),o=!0)}}catch(t){console.error("Lỗi khi trích xuất từ Haravan.theme:",t)}}}const s=t.querySelector('div#ega-uti-editable-content[data-platform="haravan"]');if(s){const t=s.getAttribute("data-id"),n=s.getAttribute("data-blog-id");null===e&&t&&(e=t),n&&(r=n)}}catch(t){console.error("Lỗi khi trích xuất ID và type:",t)}return{id:e,type:n,blogId:r,deft:o}}function getCmsLink(t,e,n,r,o){if(!e||"Không xác định"===e||"Lỗi"===e)return"";const a=new URL(t).origin;switch(n){case"home":return`${a}/admin/sale_channels/online_store/themes/${e}/setting`;case"page":return`${a}/admin/sale_channels/online_store/pages/${e}`;case"blog":return o?`${a}/admin/sale_channels/online_store/themes/${e}/edit`:`${a}/admin/sale_channels/online_store/blogs/${e}`;case"article":return`${a}/admin/sale_channels/online_store/blogs/${r}/articles/${e}`;case"collection":return o?`${a}/admin/sale_channels/online_store/themes/${e}/edit`:`${a}/admin/products/collections/${e}`;case"product":return`${a}/admin/products/${e}`;default:return""}}function updateRow(t,e,n,r){t.classList.remove("loading-row"),t.innerHTML=`\n        <td>${e}</td>\n        <td title="${n}"><a href="${n}" target="_blank">${n}</a></td>\n        <td>${r.type}</td>\n        <td>${r.id}</td>\n        <td  title="${r.cmsLink}">${r.cmsLink.includes("http")?`<a href="${r.cmsLink}" target="_blank">${r.cmsLink}</a>`:r.cmsLink}</td>\n        <td title="${r.level1}">${r.level1}</td>\n        <td title="${r.level2}">${r.level2}</td>\n        <td title="${r.level3}">${r.level3}</td>\n        <td title="${r.level4}">${r.level4}</td>\n        <td title="${r.level5}">${r.level5}</td>\n        <td title="${r.title}">${r.title}</td>\n        <td title="${r.metaDescription}">${r.metaDescription}</td>\n    `,""==r.id&&(t.classList.add("error"),appState.errorUrls.includes(n)||appState.errorUrls.push(n),updateButtonStates())}async function processChunk(t,e,n,r,o){const a=t.map(((t,a)=>getUrlInfo(t).then((s=>{r(e[n+a],n+a+1,t,s),o&&""!==s.id&&o(e[n+a]),statsState.processedUrls++,updateStats()})).catch((()=>{r(e[n+a],n+a+1,t,errorResult),statsState.processedUrls++,updateStats()}))));await Promise.all(a)}async function processUrls(){if(appState.isProcessing)return void toast.show("Đang xử lý, vui lòng đợi...","warning");const t=elements.urlInput,e=document.querySelector("#resultTable tbody"),n=t.value.split("\n").filter((t=>t.trim()));if(!n.length)return void toast.show("Vui lòng nhập ít nhất một URL","warning");statsState.startTime=Date.now(),statsState.totalUrls=n.length,statsState.processedUrls=0,updateStats(),appState.isProcessing=!0,e.innerHTML="",appState.successUrls=[],appState.errorUrls=[],appState.currentProxy=0;const r=n.map(((t,n)=>{const r=document.createElement("tr");return r.className="loading-row",r.innerHTML=`\n            <td>${n+1}</td>\n            <td><a href="${t}" target="_blank">${t}</a></td>\n            <td colspan="11">\n                <div class="loading">Đang xử lý...</div>\n            </td>\n        `,e.appendChild(r),r}));try{for(let t=0;t<n.length;t+=50){const e=n.slice(t,t+50);await processChunk(e,r,t,updateRow)}appState.hasData=!0,toggleButtons.actionButtons(!0),updateTableHeaders(),checkForErrors()}catch(t){}finally{appState.isProcessing=!1,statsState.endTime=Date.now(),updateStats(),document.querySelectorAll(".loading-row").forEach((t=>t.classList.remove("loading-row")))}}async function retryErrorUrls(){if(appState.isProcessing)return void toast.show("Đang xử lý, vui lòng đợi...","warning");if(!appState.errorUrls.length)return void toast.show("Không có URL lỗi để thử lại","info");appState.errorUrls.forEach((t=>urlCache.delete(t))),statsState.startTime=Date.now(),statsState.totalUrls=appState.errorUrls.length,statsState.processedUrls=0,updateStats(),appState.isProcessing=!0,appState.currentProxy=(appState.currentProxy+1)%appState.proxyList.length;const t=document.querySelector("#resultTable tbody"),e=Array.from(t.querySelectorAll("tr.error"));e.forEach((t=>{t.classList.add("loading-row");const e=t.cells,n=e[1].querySelector("a").href;t.innerHTML=`\n            <td>${e[0].textContent}</td>\n            <td><a href="${n}" target="_blank">${n}</a></td>\n            <td colspan="11">\n                <div class="loading">Đang xử lý...</div>\n            </td>\n        `}));try{const t=[...appState.errorUrls];appState.errorUrls=[],toast.show(`Bắt đầu thử lại ${t.length} URL lỗi...`,"info");for(let n=0;n<e.length;n+=50){const r=t.slice(n,n+50);await processChunk(r,e,n,updateRow,(t=>{t.classList.remove("error"),t.classList.add("retry-success"),t.classList.add("success-animation"),setTimeout((()=>t.classList.remove("success-animation")),1e3)}))}}catch(t){toast.show("Có lỗi xảy ra khi thử lại URLs","error")}finally{appState.isProcessing=!1,statsState.endTime=Date.now(),updateStats(),updateButtonStates();const t=appState.errorUrls.length;0===t?toast.show("Đã xử lý lại thành công tất cả URL!","success"):toast.show(`Đã xử lý lại xong. Còn ${t} URL vẫn bị lỗi.`,"warning")}}function extractBreadcrumbCategories(t,e){const n=Object.fromEntries(Array.from({length:MAX_LEVELS},((t,e)=>[`level${e+1}`,""])));if("page"==t)return n;return assignCategories(extractBreadcrumbItems(e),n,e.querySelector("h1")?.textContent.trim()||e.querySelector("h2")?.textContent.trim()||e.querySelector("title")?.textContent.trim()||""),n}function extractFromEntryCategory(t){const e=t.querySelector("h6.entry-category");if(!e)return[];const n=e.querySelectorAll("a[rel='category tag']");return n&&0!==n.length?Array.from(n).map((t=>t.textContent.trim())).filter((t=>t&&!HOME_KEYWORDS.includes(t))):[]}function extractBreadcrumbItems(t){const e=[extractFromJsonLD,extractFromSchemaOrg,extractFromRankMath,extractFromWooCommerce,extractFromClearfix,extractFromSimpleContainer,extractFromSimpleBreadcrumb,extractFromEntryCategory];for(const n of e){const e=n(t);if(e.length>0)return normalizeItems(e)}return[]}function findBreadcrumbList(t){if(Array.isArray(t)){for(const e of t){const t=findBreadcrumbList(e);if(t)return t}return null}if(t&&"object"==typeof t){if("BreadcrumbList"===t["@type"]&&Array.isArray(t.itemListElement))return t;for(const e in t){const n=findBreadcrumbList(t[e]);if(n)return n}}return null}function extractFromJsonLD(t){const e=Array.from(t.querySelectorAll('script[type="application/ld+json"]'));for(const t of e)try{const e=findBreadcrumbList(JSON.parse(t.textContent));if(e){const t=e.itemListElement.map((t=>t.name||t.item&&t.item.name||"")).filter((t=>t&&!HOME_KEYWORDS.includes(t)));if(t.length>0)return t}}catch(t){console.warn("Error parsing JSON-LD:",t)}return[]}function extractFromSchemaOrg(t){const e=[],n=t.querySelectorAll('[itemtype*="schema.org/BreadcrumbList"]');for(const t of n){const n=Array.from(t.children).filter((t=>"li"===t.tagName.toLowerCase()&&!t.classList.contains("home")));for(const t of n){const n=t.querySelectorAll('[itemprop="itemListElement"]');if(n.length>0){for(const t of n){const n=t.querySelector('[itemprop="name"]');n&&addValidItem(e,n.textContent)}continue}const r=t.querySelector('[itemprop="name"]');r?addValidItem(e,r.textContent):addValidItem(e,t.textContent.replace(/[,\/>]/g,""))}if(e.length>0)return e}return[]}function extractFromRankMath(t){const e=t.querySelector(".rank-math-breadcrumb");if(!e)return[];return["a","span.last"].flatMap((t=>Array.from(e.querySelectorAll(t)).map((t=>t.textContent.trim())).filter((t=>t&&!HOME_KEYWORDS.includes(t)))))}function extractFromSimpleBreadcrumb(t){const e=t.querySelector("nav.breadcrumb");if(!e)return[];const n=Array.from(e.querySelectorAll("a")).map((t=>t.textContent.trim())).filter((t=>t&&!HOME_KEYWORDS.includes(t)));if(0===n.length){const t=e.textContent.trim();if(t)return t.split(/[>\/\\\|→]/).map((t=>t.trim())).filter((t=>t&&!HOME_KEYWORDS.includes(t)&&!/^[\/,\s]+$/.test(t)))}return n}function extractFromWooCommerce(t){const e=t.querySelector(".woocommerce-breadcrumb");return e?Array.from(e.childNodes).map((t=>1===t.nodeType&&"a"===t.tagName.toLowerCase()||3===t.nodeType?t.textContent.trim():"")).filter(Boolean):[]}function extractFromClearfix(t){const e=t.querySelector(".ty-breadcrumbs");return e?Array.from(e.querySelectorAll('.ty-breadcrumbs__a [itemprop="name"]')).map((t=>t.textContent.trim())):[]}function extractFromSimpleContainer(t){const e=t.querySelector(".main-breadc");return e?Array.from(e.childNodes).map((t=>t.textContent.trim())).filter(Boolean):[]}function addValidItem(t,e){const n=e.replace(/\s+/g," ").trim();!n||HOME_KEYWORDS.includes(n)||/^[\/,\s]+$/.test(n)||t.push(n)}function normalizeItems(t){return t.map((t=>t.replace(/\s+/g," ").trim())).filter(((t,e,n)=>n.indexOf(t)===e&&""!==t&&!HOME_KEYWORDS.includes(t)&&!/^[\/,\s]+$/.test(t)))}function normalizeText(t){return t.trim().replace(/\s+/g," ").replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").toLowerCase()}function assignCategories(t,e,n){const r=normalizeText(n);let o=t.map((t=>({original:t,normalized:normalizeText(t)})));o.length>0&&o[o.length-1].normalized===r&&o.pop(),o.slice(0,MAX_LEVELS).forEach(((t,n)=>{e[`level${n+1}`]=t.original}))}function createCustomPrompt(t,e,n=""){return new Promise((r=>{const o=document.createElement("div");o.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background-color: rgba(0, 0, 0, 0.5);\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            z-index: 9999;\n        ";const a=document.createElement("div");a.style.cssText="\n            background-color: white;\n            padding: 20px;\n            border-radius: 5px;\n            min-width: 400px;\n            box-shadow: 0 3px 7px rgba(0, 0, 0, 0.3);\n            position: fixed;\n            top: 28px;\n        ";const s=document.createElement("h3");s.textContent=t,s.style.cssText="\n            margin-top: 0;\n            margin-bottom: 15px;\n            font-size: 16px;\n            font-weight: bold;\n        ";const l=document.createElement("p");l.textContent=e,l.style.cssText="\n            margin-bottom: 15px;\n        ";const i=document.createElement("input");i.type="text",i.focus(),i.placeholder=n,i.style.cssText="\n            width: 100%;\n            padding: 8px;\n            box-sizing: border-box;\n            margin-bottom: 15px;\n            border: 1px solid #ccc;\n            border-radius: 3px;\n        ";const c=document.createElement("div");c.style.cssText="\n            display: flex;\n            justify-content: flex-end;\n        ";const u=document.createElement("button");u.textContent="OK",u.style.cssText="\n            padding: 6px 12px;\n            background-color: #007bff;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n            margin-left: 10px;\n        ",u.addEventListener("click",(()=>{document.body.removeChild(o),r(i.value)}));const d=document.createElement("button");d.textContent="Cancel",d.style.cssText="\n            padding: 6px 12px;\n            background-color: #6c757d;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n        ",d.addEventListener("click",(()=>{document.body.removeChild(o)})),c.appendChild(d),c.appendChild(u),a.appendChild(s),a.appendChild(l),n&&a.appendChild(i),a.appendChild(c),o.appendChild(a),document.body.appendChild(o),i.focus(),i.addEventListener("keydown",(t=>{"Enter"===t.key&&(document.body.removeChild(o),r(i.value))}))}))}async function getSitemapURLs(){const t=await createCustomPrompt("Nhập URL của sitemap","","Ví dụ: https://example.com/sitemap.xml");if(isValidUrl(t))try{toast.show("Đang tải sitemap...","info");const e=appState.proxyList[appState.currentProxy]+encodeURIComponent(t),n=await timeoutPromise(fetch(e));if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const r=await n.text();if(!r.includes("<?xml")&&!r.includes("<urlset")&&!r.includes("<sitemapindex"))throw new Error("Nội dung không phải là sitemap XML hợp lệ.");const o=(new DOMParser).parseFromString(r,"text/xml"),a=o.querySelector("parsererror");if(a)throw new Error("Lỗi khi phân tích XML: "+a.textContent);const s=o.getElementsByTagName("sitemap");if(s.length>0){const t=Array.from(s).map((t=>{const e=t.getElementsByTagName("loc")[0];return e?e.textContent.trim():null})).filter(Boolean);if(0===t.length)return void toast.show("Không tìm thấy sitemap con nào.","warning");const e="loading-sitemaps-"+Date.now();toast.showWithId(`Đang tải ${t.length} sitemap con...`,"info",999999,e);let n=[],r=0,o=0;for(let a=0;a<t.length;a++)try{const o=await fetchSingleSitemap(t[a]);n=[...n,...o],r++,toast.updateMessage(e,`Đang tải sitemap con (${r}/${t.length})...`)}catch(e){console.error(`Lỗi khi tải sitemap con ${a+1}:`,e),o++,a<t.length-1&&(appState.currentProxy=(appState.currentProxy+1)%appState.proxyList.length)}return toast.hide(e),void updateUrlInput(n)}updateUrlInput(extractUrlsFromXml(o))}catch(t){if(console.error("Error loading sitemap:",t),toast.show(`Lỗi khi tải sitemap: ${t.message}`,"error"),t.message.includes("timeout")||t.message.includes("CORS")){appState.currentProxy=(appState.currentProxy+1)%appState.proxyList.length;null!==await createCustomPrompt("Lỗi kết nối","Lỗi kết nối. Bạn có muốn thử lại với proxy khác không?","")&&getSitemapURLs()}}else toast.show("URL sitemap không hợp lệ.","error")}async function fetchSingleSitemap(t){const e=appState.proxyList[appState.currentProxy]+encodeURIComponent(t),n=await timeoutPromise(fetch(e),6e4);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const r=await n.text();r.includes("<urlset")||r.includes("<url>")||console.warn("Định dạng sitemap không chuẩn:",r.substring(0,200)+"...");let o=[];try{const t=new DOMParser;o=extractUrlsFromXml(t.parseFromString(r,"text/xml"))}catch(t){console.warn("Lỗi khi phân tích XML bằng DOMParser:",t)}return 0===o.length&&(o=extractUrlsWithRegex(r)),o}function extractUrlsFromXml(t){const e=t.getElementsByTagName("url");if(0===e.length){console.warn("Không tìm thấy thẻ <url> trong sitemap, thử tìm các thẻ khác.");const e=Array.from(t.querySelectorAll("*|url")).filter((t=>t.tagName.includes("url")));if(e.length>0){const t=e.map((t=>{const e=t.querySelector("*|loc")||Array.from(t.children).find((t=>t.tagName.toLowerCase().includes("loc")));return e?e.textContent.trim():null})).filter(Boolean);return console.log(`Tìm thấy ${t.length} URL từ các namespace khác.`),t}return[]}const n=Array.from(e).map((t=>{const e=t.getElementsByTagName("loc")[0];return e?e.textContent.trim():null})).filter((t=>t&&isValidUrl(t)));return console.log(`Tìm thấy ${n.length} URL từ sitemap.`),n}function extractUrlsWithRegex(t){const e=[...t.matchAll(/<loc>\s*(https?:\/\/[^<\s]+)\s*<\/loc>/g)].map((t=>t[1].trim())).filter((t=>isValidUrl(t)));return console.log(`Tìm thấy ${e.length} URL bằng regex.`),e}function updateUrlInput(t){if(0===t.length)return void toast.show("Không tìm thấy URL nào trong sitemap.","warning");const e=elements.urlInput,n=new Set(e.value.split("\n").map((t=>t.trim())).filter((t=>t&&isValidUrl(t))));let r=0;t.forEach((t=>{n.has(t)||(n.add(t),r++)})),e.value=Array.from(n).join("\n"),toggleButtons.pasteButton(),toast.show(`Đã thêm ${r} URL mới vào danh sách (Tổng: ${n.size} URL).`,"success")}function isValidUrl(t){try{const e=new URL(t);return"http:"===e.protocol||"https:"===e.protocol}catch(t){return!1}}document.addEventListener("DOMContentLoaded",(()=>{toggleButtons.init(),elements.copyTableBtn.onclick=copyTable,elements.exportCsvBtn.onclick=exportCSV,document.getElementById("retryError").onclick=retryErrorUrls,elements.clearBtn.onclick=clearData,document.addEventListener("keydown",(t=>{"Enter"===t.key&&elements.urlInput.value&&processUrls()}))}));