function buildCategoryTree(e){if(!e||!Array.isArray(e)||0===e.length)return{};const t=JSON.parse(JSON.stringify(e));t.forEach((e=>{if(e&&e.display_name===e.parent){const n=t.filter((t=>t.display_name===e.display_name&&t.parent!==e.display_name&&t.parent));n.length>0&&(e.parent=n[0].parent)}}));const n={};t.forEach((e=>{e&&e.display_name&&(n[e.display_name]?(e.parent&&e.parent!==e.display_name&&(n[e.display_name].parent=e.parent),e.id&&!n[e.display_name].id&&(n[e.display_name].id=e.id)):n[e.display_name]={id:e.id,parent:e.parent,children:{}})}));const o={};return Object.keys(n).forEach((e=>{const t=(e=>{if(!e||!n[e])return[];const t=[];let o=e;const a=new Set;for(;o&&!a.has(o);){a.add(o),n[o]&&t.unshift(o);const e=n[o]?.parent;if(!e||!n[e]||e===o)break;o=e}return t})(e);if(0===t.length)return;let a=o;for(let e=0;e<t.length;e++){const o=t[e];a[o]||(a[o]={},n[o]&&n[o].id&&(a[o]._meta={id:n[o].id})),a=a[o]}})),o}function createFlattenedList(e){if(!e||"object"!=typeof e)return[];const t=[];return function e(n,o=[],a=0){if(!n||"object"!=typeof n)return;const s=Object.keys(n).filter((e=>"_meta"!==e));s&&0!==s.length&&s.forEach((s=>{if(!s)return;let r=null;n[s]&&n[s]._meta&&n[s]._meta.id&&(r=n[s]._meta.id);const c=[...o,s],l=Array(5).fill("");for(let e=0;e<Math.min(c.length,5);e++)l[e]=c[e];t.push({name:s,path:c.join(" > "),level:a,id:r,levels:l}),n[s]&&"object"==typeof n[s]&&Object.keys(n[s]).filter((e=>"_meta"!==e)).length>0&&e(n[s],c,a+1)}))}(e),t}function createCmsLink(e){if(!e)return"Không có ID";return`https://cms.gumac.vn/product-categories/${e}/edit`}function populateCategoryTable(e){e&&Array.isArray(e)||(e=[]);const t=document.querySelector("#categoryTable tbody");t&&(t.innerHTML="",e.forEach(((e,n)=>{if(!e)return;const o=document.createElement("tr"),a=document.createElement("td");a.textContent=n+1,o.appendChild(a);for(let t=0;t<5;t++){const n=document.createElement("td"),a=e.levels[t]||"";n.textContent=a,a&&(n.className="tooltip",n.setAttribute("data-tooltip",a)),o.appendChild(n)}const s=document.createElement("td");s.className="link-column tooltip";const r=createCmsLink(e.id);s.innerHTML=`<a href="${r}" target="_blank" rel="noopener noreferrer">${r}</a>`,s.setAttribute("data-tooltip",r),o.appendChild(s),t.appendChild(o)})))}function processJSON(){const e=document.getElementById("jsonInput").value,t=document.getElementById("output"),n=document.getElementById("info");if(n&&(n.innerHTML=""),t)try{let o;try{if(!e||""===e.trim())throw new Error("Vui lòng nhập dữ liệu JSON");o=JSON.parse(e)}catch(e){throw new Error(`Lỗi phân tích JSON: ${e.message}`)}const a=extractAllCategories(o);if(!a||0===a.length)throw new Error("Không tìm thấy dữ liệu danh mục hợp lệ trong JSON.");n&&(n.innerHTML=`<div class="info" style="inline">Đã tìm thấy ${a.length} danh mục.</div>`),showToast(`Đã tìm thấy ${a.length} danh mục.`,"success");const s=buildCategoryTree(a),r=JSON.parse(JSON.stringify(s));removeMetaFromTree(r);const c=`${JSON.stringify(r,null,2)};`;t.innerText=c,t.classList.remove("error");const l=createFlattenedList(s);populateCategoryTable(l),console.log("Categories:",a),console.log("Tree:",s),console.log("Flattened list:",l)}catch(e){console.error("Error:",e),t.innerText=`Lỗi: ${e.message}`,t.classList.add("error"),showToast(e.message,"error");const n=document.querySelector("#categoryTable tbody");n&&(n.innerHTML="")}}function removeMetaFromTree(e){e&&"object"==typeof e&&(e._meta&&delete e._meta,Object.keys(e).forEach((t=>{e[t]&&"object"==typeof e[t]&&removeMetaFromTree(e[t])})))}function extractAllCategories(e){if(!e)return[];const t=[],n=new Set;return function e(o){if(o)if(Array.isArray(o))o.forEach((t=>e(t)));else if(o&&"object"==typeof o&&Array.isArray(o.data))o.data.forEach((t=>e(t)));else if(o&&"object"==typeof o&&o.display_name){const e=`${o.id?o.id:`unknown_${o.display_name}`}_${o.display_name}`;n.has(e)||(n.add(e),t.push({id:o.id||null,display_name:o.display_name,parent:o.parent||null}))}else o&&"object"==typeof o&&Object.values(o).forEach((t=>e(t)))}(e),t}function copyOutput(){const e=document.getElementById("output");if(!e)return;const t=e.innerText;t&&"Kết quả sẽ hiển thị ở đây..."!==t?navigator.clipboard.writeText(t).then((()=>{showToast("Sao chép CATEGORY_TREE thành công!","success")})).catch((e=>{showToast("Không thể sao chép: "+e,"error")})):showToast("Không có dữ liệu để sao chép!","warning")}function copyTable(){const e=document.getElementById("categoryTable");if(!e||e.rows.length<=1)return void showToast("Không có dữ liệu để sao chép!","warning");let t=[],n=[];for(let t=0;t<e.rows[0].cells.length;t++)n.push(e.rows[0].cells[t].textContent);t.push(n.join("\t"));for(let n=1;n<e.rows.length;n++){let o=[];for(let t=0;t<e.rows[n].cells.length;t++)o.push(e.rows[n].cells[t].textContent);t.push(o.join("\t"))}const o=t.join("\n");navigator.clipboard.writeText(o).then((()=>{showToast("Sao chép bảng dữ liệu thành công!","success")})).catch((e=>{showToast("Không thể sao chép: "+e,"error")}))}function exportTableToCSV(){const e=document.getElementById("categoryTable");if(!e||e.rows.length<=1)return void showToast("Không có dữ liệu để xuất!","warning");let t=[],n=[];for(let t=0;t<e.rows[0].cells.length;t++)n.push('"'+e.rows[0].cells[t].textContent+'"');t.push(n.join(","));for(let n=1;n<e.rows.length;n++){let o=[];for(let t=0;t<e.rows[n].cells.length;t++){let a=e.rows[n].cells[t].textContent||"";o.push('"'+a.replace(/"/g,'""')+'"')}t.push(o.join(","))}const o=t.join("\n"),a="danh_mục_"+(new Date).toISOString().slice(0,10)+".csv",s=new Blob([o],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.download=a,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),showToast("Xuất file CSV thành công!","success")}function showToast(e,t="info"){document.querySelectorAll(".toast").forEach((e=>{e.classList.contains("toast-removing")||removeToast(e)}));let n=document.getElementById("toast-container");n||(n=document.createElement("div"),n.id="toast-container",document.body.appendChild(n));const o=document.createElement("div");o.className=`toast toast-${t}`;let a="";switch(t){case"success":a='<span class="toast-icon">✓</span>';break;case"error":a='<span class="toast-icon">✕</span>';break;case"warning":a='<span class="toast-icon">⚠</span>';break;default:a='<span class="toast-icon">ℹ</span>'}o.innerHTML=`\n        ${a}\n        <span class="toast-message">${e}</span>\n    `,n.appendChild(o),setTimeout((()=>{o.classList.add("toast-visible")}),10),setTimeout((()=>{removeToast(o)}),3e3)}function removeToast(e){e.classList.add("toast-removing"),e.classList.remove("toast-visible"),setTimeout((()=>{e.parentNode&&e.parentNode.removeChild(e)}),300)}