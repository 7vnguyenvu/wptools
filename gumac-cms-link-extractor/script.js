const SLUG_REPLACEMENTS={"ao-so-mi-hoa-tiet":"ao-so-mi-nu-hoa-tiet","quan-tay-ong-suong":"quan-tay-nu-ong-suong","quan-tay-ong-dung":"quan-tay-nu-ong-dung","quan-tay-ong-rong":"quan-tay-nu-ong-rong","quan-tay-cong-so":"quan-tay-nu-cong-so","quan-jeans-nu":"quan-dai-jean","ao-so-mi-kieu":"ao-so-mi-nu-kieu","ao-vest-blazer":"ao-vest","vay-dam-xep-ly":"dam-xep-ly"},URL_PATTERNS={page:(t,e)=>`${t}/${e}`,category:(t,e)=>`${t}/tin-tuc?category=${e}`,post:(t,e)=>`${t}/tin-tuc/${e}`,collection:(t,e)=>`${t}/bo-suu-tap/${e}`,product_cat:(t,e)=>`${t}/${e}`,product:(t,e,n)=>`${t}/${e}/${n}`};let CATEGORY_TREE={};const CONFIG={domain:"https://gumac.vn",cmsBaseUrl:"https://cms.gumac.vn",toastDuration:3e3,fadeOutDuration:300,localStorageKey:"gumac_category_tree"},toggleButtons={inputRelatedButtons:()=>{const t=document.getElementById("pasteButton"),e=document.getElementById("clear"),n=document.getElementById("jsonInput").value.trim().length>0;t&&(t.style.display=n?"none":"inline-block"),e&&(e.style.display=n?"inline-block":"none")},actionButtons:t=>{[document.getElementById("copyTableBtn"),document.getElementById("exportCsvBtn")].forEach((e=>{e&&(e.style.display=t?"inline-block":"none")}))},init:()=>{toggleButtons.actionButtons(!1),toggleButtons.inputRelatedButtons()}};function showToast(t,e="success"){const n=document.querySelector(".toast-container"),o=document.createElement("div");o.className=`toast ${e}`,o.textContent=t,n.appendChild(o),o.offsetHeight,setTimeout((()=>o.classList.add("show")),10),setTimeout((()=>{o.classList.remove("show"),setTimeout((()=>n.removeChild(o)),CONFIG.fadeOutDuration)}),CONFIG.toastDuration)}function saveCategoryTree(){try{return localStorage.setItem(CONFIG.localStorageKey,JSON.stringify(CATEGORY_TREE)),showToast("Đã cập nhật và lưu cây danh mục thành công!"),!0}catch(t){return console.error("Lỗi khi lưu cây danh mục:",t),showToast("Lỗi khi lưu cây danh mục. "+t.message,"error"),!1}}function loadCategoryTree(){try{const t=localStorage.getItem(CONFIG.localStorageKey);if(t){CATEGORY_TREE=JSON.parse(t);return document.getElementById("cateTreeInput").value=JSON.stringify(CATEGORY_TREE,null,2),!0}return!1}catch(t){return console.error("Lỗi khi tải cây danh mục:",t),showToast("Lỗi khi tải cây danh mục. "+t.message,"error"),!1}}function clearCategoryTree(){try{return localStorage.removeItem(CONFIG.localStorageKey),document.getElementById("cateTreeInput").value="",CATEGORY_TREE={},showToast("Đã xóa cây danh mục!"),!0}catch(t){return console.error("Lỗi khi xóa cây danh mục:",t),showToast("Lỗi khi xóa cây danh mục. "+t.message,"error"),!1}}function parseCategoryTree(){const cateTreeInput=document.getElementById("cateTreeInput").value.trim();if(!cateTreeInput)return!!loadCategoryTree()||(showToast("Vui lòng nhập cấu trúc cây danh mục","error"),!1);try{let jsCode=cateTreeInput;if(jsCode.includes("=")||(jsCode="CATEGORY_TREE = "+jsCode),eval(jsCode),"object"!=typeof CATEGORY_TREE||null===CATEGORY_TREE)throw new Error("Cây danh mục không phải là đối tượng hợp lệ");return saveCategoryTree(),!0}catch(t){return console.error("Lỗi khi phân tích cây danh mục:",t),showToast("Lỗi khi phân tích cây danh mục. Vui lòng kiểm tra định dạng.","error"),!1}}function getCleanHeaderText(t){const e=t.querySelector(".header-content");if(e){const t=e.cloneNode(!0),n=t.querySelector(".header-copy-btn");return n&&n.remove(),t.textContent.trim()}return t.textContent.trim()}function copyColumnData(t){const e=document.getElementById("resultTable"),n=Array.from(e.rows).slice(1).map((e=>e.cells[t].textContent.trim())).join("\n");navigator.clipboard.writeText(n).then((()=>{const n=e.querySelector(`th:nth-child(${t+1})`).querySelector(".header-copy-btn"),o=n.style.cssText,r=n.textContent;n.textContent="Copied!",n.style.backgroundColor="#90EE90",n.style.borderColor="#4CAF50",setTimeout((()=>{n.textContent=r,n.style.cssText=o}),1e3),showToast("Đã sao chép thành công!")})).catch((t=>{showToast("Không thể sao chép. Vui lòng thử lại.","error")}))}function createHeaderCopyButton(t){const e=document.createElement("button");return e.className="header-copy-btn",e.innerHTML="Copy",e.style.cssText="\n                margin-left: .5rem;\n                cursor: pointer;\n                background: #f0f0f0;\n                border: 1px solid #ddd;\n                border-radius: 3px;\n                padding: 2px 6px;\n                font-size: 12px;\n                opacity: 0.8;\n                transition: all 0.2s ease;\n            ",e.onmouseover=()=>{e.style.opacity="1",e.style.backgroundColor="#e0e0e0"},e.onmouseout=()=>{e.style.opacity="0.8",e.style.backgroundColor="#f0f0f0"},e.onclick=e=>{e.stopPropagation(),copyColumnData(t)},e}async function pasteFromClipboard(){try{const t=await navigator.clipboard.readText();document.getElementById("jsonInput").value=t,toggleButtons.inputRelatedButtons(),showToast("Đã dán nội dung thành công!")}catch(t){showToast("Không thể truy cập clipboard. Vui lòng dán thủ công.","error")}}async function pasteCategoryTreeFromClipboard(){try{const t=await navigator.clipboard.readText();document.getElementById("cateTreeInput").value=t,showToast("Đã dán cấu trúc cây danh mục thành công!")}catch(t){showToast("Không thể truy cập clipboard. Vui lòng dán thủ công.","error")}}function determineType(t){if(t.action){const e=(new DOMParser).parseFromString(t.action,"text/html").querySelector(".btn-edit");if(e){const t=e.getAttribute("href");if(t.includes("/pages/"))return"page";if(t.includes("/categories/"))return"category";if(t.includes("/product-categories/"))return"product_cat";if(t.includes("/posts/"))return"post";if(t.includes("/collections/"))return"collection"}}return"product"}function getDisplayName(t){return t.crm_name||t.title||t.name||t.display_name||""}function getCmsLink(t){const e=t.id;switch(determineType(t)){case"page":return`${CONFIG.cmsBaseUrl}/pages/${e}/edit`;case"category":return`${CONFIG.cmsBaseUrl}/categories/${e}/edit`;case"product_cat":return`${CONFIG.cmsBaseUrl}/product-categories/${e}/edit`;case"post":return`${CONFIG.cmsBaseUrl}/posts/${e}/edit`;case"collection":return`${CONFIG.cmsBaseUrl}/collections/${e}/edit`;default:return`${CONFIG.cmsBaseUrl}/products/${e}/edit`}}function getCategoryLevels(t){const e=determineType(t),n=getDisplayName(t);let o=[];if("category"===e||"post"===e){o=["Tin tức"];const e=(t.category||t.category_name||"").trim();return e&&o.push(e),Array.from({length:5},((t,e)=>o[e]||""))}if("collection"===e)return o=["Bộ sưu tập",n.trim()],Array.from({length:5},((t,e)=>o[e]||""));function r(t,e,n=[]){if(e in t)return[...n,e];for(const[o,a]of Object.entries(t)){const t=r(a,e,[...n,o]);if(t)return t}return null}if("product"===e||"product_cat"===e){const a="product"===e?(t.category||"").trim():n.trim();for(const[t,e]of Object.entries(CATEGORY_TREE)){const n=r({[t]:e},a);if(n){o=n;break}}}return Array.from({length:5},((t,e)=>o[e]||""))}function toSlug(t){return t?t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[đĐ]/g,"d").replace(/[^a-zA-Z0-9\s]/g,"").replace(/\s+/g,"-"):""}function processCategoryPath(t){if(!t)return"";const e=toSlug(t);return SLUG_REPLACEMENTS[e]||e}function getUrl(t,e){const n=CONFIG.domain,o=t.slug||"";if(!e||!o)return"";const r=URL_PATTERNS[e];if(!r)return"";if("product"===e){return r(n,processCategoryPath(getCategoryLevels(t).filter((t=>t)).at(-1)),o)}return r(n,o)}function processJson(){if(!parseCategoryTree())return;const t=document.getElementById("jsonInput").value;if(t.trim())try{const e=t.split(/}\s*{/).map(((e,n)=>(n>0&&(e="{"+e),n<t.split(/}\s*{/).length-1&&(e+="}"),JSON.parse(e)))),n=document.querySelector("#resultTable tbody");n.innerHTML="";let o=0;const r=document.querySelector("#resultTable thead tr");r.querySelectorAll(".header-copy-btn").forEach((t=>t.remove()));const a=new Array(11).fill(!1);e.forEach((t=>{t.data&&Array.isArray(t.data)&&t.data.forEach((t=>{if(t.active){const e=getCategoryLevels(t),r=determineType(t),c=getCmsLink(t),s=getDisplayName(t),l=getUrl(t,r),i=n.insertRow();[o+1,l,s,r,t.id,c,...e].forEach(((t,e)=>{t&&(a[e]=!0);const n=i.insertCell();if(1===e){const e=document.createElement("a");e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.textContent=t,n.appendChild(e)}else if(3===e){const e=document.createElement("span");e.className="type-label",e.textContent=t,n.appendChild(e)}else if(5===e){const e=document.createElement("a");e.href=t,e.target="_blank",e.rel="noopener noreferrer",e.textContent=t,n.appendChild(e)}else n.textContent=t})),o++}}))}));r.querySelectorAll("th").forEach(((t,e)=>{if(a[e]){const n=document.createElement("div");n.className="header-content",n.textContent=t.textContent;const o=createHeaderCopyButton(e);n.appendChild(o),t.textContent="",t.appendChild(n)}})),o>0?(toggleButtons.actionButtons(!0),showToast("Đã xử lý dữ liệu thành công!")):(toggleButtons.actionButtons(!1),showToast("Không tìm thấy dữ liệu hợp lệ trong nội dung JSON","error"))}catch(t){console.error("Error processing JSON:",t),toggleButtons.actionButtons(!1),showToast("Lỗi khi xử lý JSON. Vui lòng kiểm tra định dạng đầu vào.","error")}else showToast("Vui lòng dán nội dung JSON vào textarea","error")}function addCateTreeButtons(){const t=document.getElementById("cateTreeInput").parentElement,e=document.createElement("div");e.className="cate-tree-buttons",e.style.cssText="margin-top: 10px; display: flex; gap: 10px; position: absolute; width: 50%; height: 30px; bottom: 0; right: 16px; justify-content: flex-end;";const n=document.createElement("button");n.id="pasteCateTreeButton",n.textContent="Dán",n.style.cssText="padding: 5px 10px; cursor: pointer; position: relative;",n.onclick=pasteCategoryTreeFromClipboard;const o=document.createElement("button");o.id="saveCateTreeButton",o.textContent="Lưu lại",o.style.cssText="padding: 5px 10px; cursor: pointer; background-color: #4CAF50; color: white; position: relative;",o.onclick=function(){document.getElementById("cateTreeInput").value.trim()?parseCategoryTree():showToast("Cấu trúc cây danh mục trống!","error")};const r=document.createElement("button");r.id="clearCateTreeButton",r.textContent="Xóa",r.style.cssText="padding: 5px 10px; cursor: pointer; background-color: #f44336; color: white; position: relative;",r.onclick=clearCategoryTree,e.appendChild(n),e.appendChild(o),e.appendChild(r),t&&t.parentNode.insertBefore(e,t.nextSibling)}document.getElementById("copyTableBtn").addEventListener("click",(function(){const t=document.getElementById("resultTable"),e=Array.from(t.rows).map((t=>Array.from(t.cells).map((t=>t.querySelector("button")?getCleanHeaderText(t):t.textContent.trim())).join("\t"))).join("\n");navigator.clipboard.writeText(e).then((()=>{const e=t.querySelector("tbody");e.style.backgroundColor="#61ff5540",setTimeout((()=>{e.style.backgroundColor=""}),700),showToast("Đã sao chép toàn bộ bảng thành công!")})).catch((t=>{showToast("Không thể sao chép. Vui lòng thử lại.","error")}))})),document.getElementById("exportCsvBtn").addEventListener("click",(function(){const t=document.getElementById("resultTable"),e=Array.from(t.querySelectorAll("thead th")).map((t=>getCleanHeaderText(t))),n=Array.from(t.querySelectorAll("tbody tr")).map((t=>Array.from(t.querySelectorAll("td")).map((t=>`"${t.textContent.trim().replace(/"/g,'""')}"`)).join(","))),o="data:text/csv;charset=utf-8,"+[e.join(","),...n].join("\n"),r=encodeURI(o),a=document.createElement("a");a.setAttribute("href",r),a.setAttribute("download","data.csv"),document.body.appendChild(a),a.click(),document.body.removeChild(a),showToast("Đã xuất file CSV thành công!")})),document.getElementById("clear").addEventListener("click",(function(){document.getElementById("jsonInput").value="",document.querySelector("#resultTable tbody").innerHTML="",toggleButtons.actionButtons(!1),toggleButtons.inputRelatedButtons(),showToast("Đã làm mới dữ liệu!")})),document.getElementById("jsonInput").addEventListener("input",(()=>{toggleButtons.inputRelatedButtons()})),document.addEventListener("DOMContentLoaded",(function(){toggleButtons.init(),addCateTreeButtons(),loadCategoryTree()}));