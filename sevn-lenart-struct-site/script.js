const CHUNK_SIZE=10,appState={hasData:!1,isProcessing:!1,successUrls:[],errorUrls:[],currentProxy:0,proxyList:["https://api.allorigins.win/raw?url=","https://api.codetabs.com/v1/proxy?quest="]},statsState={startTime:0,endTime:0,totalUrls:0,processedUrls:0},toast={container:null,queue:[],timeoutId:null,init(){this.container||(this.container=document.createElement("div"),this.container.className="toast-container",document.body.appendChild(this.container))},show(t,e="info",r=3500){this.init();const n=document.createElement("div");n.className=`toast toast-${e}`,n.textContent=t,this.queue.push({element:n,duration:r}),this.processQueue()},processQueue(){if(this.timeoutId||0===this.queue.length)return;const{element:t,duration:e}=this.queue.shift();this.container.appendChild(t),setTimeout((()=>t.classList.add("show")),10),this.timeoutId=setTimeout((()=>{t.classList.remove("show"),setTimeout((()=>{t.remove(),this.timeoutId=null,this.processQueue()}),300)}),e)}};function formatTime(t){if(t<60)return`${t} giây`;const e=Math.floor(t/86400);t%=86400;const r=Math.floor(t/3600);t%=3600;const n=Math.floor(t/60);let o="";return e>0&&(o+=`${e} ngày `),r>0&&(o+=`${r} giờ `),n>0&&(o+=`${n} phút `),((t=Math.floor(t%60))>0||""===o)&&(o+=`${t} giây`),o.trim()}function updateStats(){const t=Date.now(),e=0==statsState.startTime?"0":(t-statsState.startTime)/1e3,r=0==statsState.processedUrls?"0":Math.ceil(statsState.processedUrls/e);document.querySelector(".detail-handle .progress").textContent=`${statsState.processedUrls}/${statsState.totalUrls}`,document.querySelector(".detail-handle .cout").textContent=statsState.totalUrls,document.querySelector(".detail-handle .time").textContent=formatTime(e),document.querySelector(".detail-handle .average-spend").textContent=r,document.querySelector(".detail-handle .err").textContent=appState.errorUrls.length}const toggleButtons={pasteButton:()=>{const t=document.getElementById("pasteButton"),e=document.getElementById("urlInput");t.style.display=e.value.trim()?"none":"block"},actionButtons:t=>{[document.getElementById("copyTableBtn"),document.getElementById("exportCsvBtn"),document.getElementById("clear")].forEach((e=>{e&&(e.style.display=t?"block":"none")}));const e=document.getElementById("retryError");e&&(e.style.display=t&&appState.errorUrls.length>0?"block":"none")},init:()=>{toggleButtons.actionButtons(!1),toggleButtons.pasteButton()}};function validateAndProcessInput(t){return t.split("\n").map((t=>t.trim())).filter((t=>t.match(/^(https?:\/\/[^\s]+)/)))}async function pasteFromClipboard(){try{const t=await navigator.clipboard.readText();document.getElementById("urlInput").value=validateAndProcessInput(t).join("\n"),toggleButtons.pasteButton()}catch(t){toast.show(`Không thể dán:  ${t}`,"error")}}function copyColumn(t){const e=document.getElementById("resultTable"),r=Array.from(e.rows).slice(1).map((e=>e.cells[t].textContent.trim())).join("\n");navigator.clipboard.writeText(r).then((()=>{const r=e.querySelector(`th:nth-child(${t+1})`).querySelector("button"),n=r.textContent,o=r.style.cssText;r.textContent="Copied!",r.style.backgroundColor="#90EE90",r.style.borderColor="#4CAF50",setTimeout((()=>{r.textContent=n,r.style.cssText=o}),1e3)})).catch((t=>toast.show(`Không thể copy:  ${t}`,"error")))}function updateTableHeaders(){if(!appState.hasData)return;const t=document.querySelector("#resultTable thead tr");if(t.querySelector("button"))return;const e=document.querySelector("#resultTable tbody"),r=Array.from(e.rows);Array.from(t.cells).forEach(((t,e)=>{if(r.some((t=>{const r=t.cells[e].textContent.trim();return r&&"Lỗi"!==r&&"Không xác định"!==r&&"Không thể tạo link CMS"!==r}))){const r=document.createElement("button");r.textContent="Copy",r.style.cssText="\n                margin-left: .5rem;\n                cursor: pointer;\n                background: #f0f0f0;\n                border: 1px solid #ddd;\n                border-radius: 3px;\n                padding: 2px 6px;\n                font-size: 12px;\n                opacity: 0.8;\n                transition: all 0.2s ease;\n            ",r.onmouseover=()=>{r.style.opacity="1",r.style.backgroundColor="#e0e0e0"},r.onmouseout=()=>{r.style.opacity="0.8",r.style.backgroundColor="#f0f0f0"},r.onclick=t=>{t.stopPropagation(),copyColumn(e)},t.appendChild(r)}}))}function copyTable(){const t=document.getElementById("resultTable"),e=Array.from(t.rows).map((t=>Array.from(t.cells).map((t=>t.querySelector("button")?getCleanHeaderText(t):t.textContent.trim())).join("\t"))).join("\n");navigator.clipboard.writeText(e).then((()=>{const e=t.querySelector("tbody");e.style.backgroundColor="#61ff5540",setTimeout((()=>e.style.backgroundColor=""),700)}))}function downloadFile(t,e,r){const n=new Blob([t],{type:r}),o=document.createElement("a");o.href=window.URL.createObjectURL(n),o.download=e,o.click()}function getCleanHeaderText(t){const e=document.createElement("div");e.innerHTML=t.innerHTML;const r=e.querySelector("button");return r&&r.remove(),e.textContent.trim()}function encodeToUTF8(t){return(new TextEncoder).encode("\ufeff"+t)}function exportCSV(){const t=document.getElementById("resultTable"),e=Array.from(t.rows),r=Array.from(e[0].cells).map((t=>getCleanHeaderText(t))),n=e.slice(1).map((t=>Array.from(t.cells).map((t=>`"${t.textContent.trim().replace(/"/g,'""')}"`)))),o=[r.join(","),...n.map((t=>t.join(",")))].join("\n"),a=new Blob([encodeToUTF8(o)],{type:"text/csv;charset=utf-8"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download="url-info-export.csv",s.click()}document.getElementById("urlInput").addEventListener("input",(function(){this.value=validateAndProcessInput(this.value).join("\n"),toggleButtons.pasteButton()}));const timeoutPromise=(t,e=3e4)=>Promise.race([t,new Promise(((t,r)=>setTimeout((()=>r(new Error("Request timeout"))),e)))]),urlCache=new Map;async function getUrlInfo(t,e=0){if(urlCache.has(t))return urlCache.get(t);const r=appState.proxyList[appState.currentProxy]+encodeURIComponent(t);try{const e=await timeoutPromise(fetch(r));if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.text(),o=(new DOMParser).parseFromString(n,"text/html");let{id:a,type:s}=getIdAndTypeFromBodyClass(o.body.getAttribute("class")||"")||getIdAndTypeFromJsonLink(o)||{id:"Không xác định",type:"Không xác định"};const l=extractBreadcrumbCategories(o),c={shortlink:getShortlink(o,t,a,s),id:a,type:s,title:o.querySelector("title")?.textContent||"Không tìm thấy title",metaDescription:o.querySelector('meta[name="description"]')?.getAttribute("content")||"",cmsLink:getCmsLink(t,a,s),...l};appState.successUrls.includes(t)||appState.successUrls.push(t);const i=appState.errorUrls.indexOf(t);return i>-1&&appState.errorUrls.splice(i,1),urlCache.set(t,c),c}catch(r){if(e<2)return appState.currentProxy=(appState.currentProxy+1)%appState.proxyList.length,await new Promise((t=>setTimeout(t,1e3*(e+1)))),getUrlInfo(t,e+1);appState.errorUrls.includes(t)||appState.errorUrls.push(t);const n={shortlink:"Lỗi",id:"Lỗi",type:"Lỗi",title:"Lỗi",metaDescription:"Lỗi",cmsLink:"Lỗi",level1:"Lỗi",level2:"Lỗi",level3:"Lỗi",level4:"Lỗi",level5:"Lỗi"};return urlCache.set(t,n),n}}function updateRow(t,e,r,n){t.classList.remove("loading-row"),t.innerHTML=`\n        <td>${e}</td>\n        <td><a href="${r}" target="_blank">${r}</a></td>\n        <td>${n.type}</td>\n        <td>${n.id}</td>\n        <td>${n.cmsLink.includes("http")?`<a href="${n.cmsLink}" target="_blank">${n.cmsLink}</a>`:n.cmsLink}</td>\n        <td>${n.level1}</td>\n        <td>${n.level2}</td>\n        <td>${n.level3}</td>\n        <td>${n.level4}</td>\n        <td>${n.level5}</td>\n        <td>${n.shortlink.includes("http")?`<a href="${n.shortlink}" target="_blank">${n.shortlink}</a>`:n.shortlink}</td>\n        <td>${n.title}</td>\n        <td>${n.metaDescription}</td>\n    `,("Lỗi"===n.id||n.shortlink.includes("Lỗi"))&&(t.classList.add("error"),appState.errorUrls.includes(r)||appState.errorUrls.push(r),updateButtonStates())}async function retryErrorUrls(){if(appState.isProcessing)return void toast.show("Đang xử lý, vui lòng đợi...","warning");if(!appState.errorUrls.length)return void toast.show("Không có URL lỗi để thử lại","info");appState.errorUrls.forEach((t=>urlCache.delete(t))),statsState.startTime=Date.now(),statsState.totalUrls=appState.errorUrls.length,statsState.processedUrls=0,updateStats(),appState.isProcessing=!0,appState.currentProxy=(appState.currentProxy+1)%appState.proxyList.length;const t=document.querySelector("#resultTable tbody"),e=Array.from(t.querySelectorAll("tr.error"));e.forEach((t=>{t.classList.add("loading-row");const e=t.cells,r=e[1].querySelector("a").href;t.innerHTML=`\n            <td>${e[0].textContent}</td>\n            <td><a href="${r}" target="_blank">${r}</a></td>\n            <td colspan="11">\n                <div class="loading">Đang xử lý...</div>\n            </td>\n        `}));try{const t=[...appState.errorUrls];appState.errorUrls=[],toast.show(`Bắt đầu thử lại ${t.length} URL lỗi...`,"info");for(let r=0;r<e.length;r+=10){const n=e.slice(r,r+10);await Promise.all(n.map((async(e,n)=>{const o=t[r+n];try{const t=await getUrlInfo(o);updateRow(e,e.cells[0].textContent,o,t),"Lỗi"===t.id||t.shortlink.includes("Lỗi")||(e.classList.remove("error"),e.classList.add("retry-success"),e.classList.add("success-animation"),setTimeout((()=>{e.classList.remove("success-animation")}),1e3)),statsState.processedUrls++,updateStats()}catch(t){updateRow(e,e.cells[0].textContent,o,{shortlink:"Lỗi",id:"Lỗi",type:"Lỗi",title:"Lỗi",metaDescription:"Lỗi",cmsLink:"Lỗi",level1:"Lỗi",level2:"Lỗi",level3:"Lỗi",level4:"Lỗi",level5:"Lỗi"}),e.classList.add("error"),appState.errorUrls.includes(o)||appState.errorUrls.push(o),statsState.processedUrls++,updateStats()}})))}}catch(t){toast.show("Có lỗi xảy ra khi thử lại URLs","error")}finally{appState.isProcessing=!1,statsState.endTime=Date.now(),updateStats(),updateButtonStates();const t=appState.errorUrls.length;0===t?toast.show("Đã xử lý lại thành công tất cả URL!","success"):toast.show(`Đã xử lý lại xong. Còn ${t} URL vẫn bị lỗi.`,"warning")}}function clearData(){const t=document.getElementById("urlInput"),e=document.querySelector("#resultTable tbody");t.value="",e.innerHTML="",appState.hasData=!1,appState.successUrls=[],appState.errorUrls=[],appState.currentProxy=0,statsState.startTime=0,statsState.endTime=0,statsState.totalUrls=0,statsState.processedUrls=0,updateStats(),toggleButtons.actionButtons(!1),toggleButtons.pasteButton(),toast.show("Đã làm mới dữ liệu","success")}function updateButtonStates(){const t=document.getElementById("retryError"),e=document.getElementById("clear"),r=document.getElementById("copyTableBtn"),n=document.getElementById("exportCsvBtn");appState.hasData?(e.style.display="block",r.style.display="block",n.style.display="block",t.style.display=appState.errorUrls.length>0?"block":"none"):(e.style.display="none",r.style.display="none",n.style.display="none",t.style.display="none")}function checkForErrors(){const t=document.querySelectorAll("#resultTable tbody tr.error");appState.errorUrls=Array.from(t).map((t=>t.querySelector("td:nth-child(2) a").href)),updateButtonStates()}function getIdAndTypeFromBodyClass(t){const e=t.match(/postid-(\d+)/)||t.match(/page-id-(\d+)/)||t.match(/term-(\d+)/)||t.match(/category-(\d+)/);if(!e)return null;let r="unknown";return t.includes("single-product")?r="product":t.includes("single-post")?r="post":t.includes("page-template")?r="page":t.includes("tax-product_cat")?r="product_cat":t.includes("category")&&(r="category"),{id:e[1],type:r}}function getIdAndTypeFromJsonLink(t){const e=t.querySelector('link[rel="alternate"][title="JSON"][type="application/json"]')?.getAttribute("href");if(!e)return null;const r=e.match(/\/(categories|tags)\/(\d+)/);return r?{id:r[2],type:"categories"===r[1]?"category":"tag"}:null}function getShortlink(t,e,r,n){let o=t.querySelector('link[rel="shortlink"]')?.getAttribute("href");if(!o&&r&&"Không xác định"!==r){const t=new URL(e).origin;switch(n){case"post":case"page":case"product":o=`${t}/?p=${r}`;break;case"product_cat":case"category":o=""}}return o}function getCategorySlugFromBodyClass(t){const e=t.match(/term-([a-zA-Z0-9-]+)/);return e?e[1]:""}function getCmsLink(t,e,r){if(!e||"Không xác định"===e||"Lỗi"===e)return"Không thể tạo link CMS";const n=new URL(t).origin;switch(r){case"page":case"post":case"product":return`${n}/wp-admin/post.php?post=${e}&action=edit`;case"product_cat":return`${n}/wp-admin/term.php?taxonomy=product_cat&tag_ID=${e}&post_type=product`;case"category":return`${n}/wp-admin/term.php?taxonomy=category&tag_ID=${e}&post_type=post`;default:return"Không thể tạo link CMS"}}async function processUrls(){if(appState.isProcessing)return void toast.show("Đang xử lý, vui lòng đợi...","warning");const t=document.getElementById("urlInput"),e=document.querySelector("#resultTable tbody"),r=t.value.split("\n").filter((t=>t.trim()));if(!r.length)return void toast.show("Vui lòng nhập ít nhất một URL","warning");statsState.startTime=Date.now(),statsState.totalUrls=r.length,statsState.processedUrls=0,updateStats(),appState.isProcessing=!0,e.innerHTML="",appState.successUrls=[],appState.errorUrls=[],appState.currentProxy=0;const n=r.map(((t,r)=>{const n=document.createElement("tr");return n.className="loading-row",n.innerHTML=`\n            <td>${r+1}</td>\n            <td><a href="${t}" target="_blank">${t}</a></td>\n            <td colspan="11">\n                <div class="loading">Đang xử lý...</div>\n            </td>\n        `,e.appendChild(n),n}));try{for(let t=0;t<r.length;t+=10){const e=r.slice(t,t+10).map(((e,r)=>getUrlInfo(e).then((o=>{updateRow(n[t+r],t+r+1,e,o),statsState.processedUrls++,updateStats()})).catch((o=>{updateRow(n[t+r],t+r+1,e,{shortlink:"Lỗi",id:"Lỗi",type:"Lỗi",title:"Lỗi",metaDescription:"Lỗi",cmsLink:"Lỗi"}),statsState.processedUrls++,updateStats()}))));await Promise.all(e)}appState.hasData=!0,toggleButtons.actionButtons(!0),updateTableHeaders(),checkForErrors()}catch(t){}finally{appState.isProcessing=!1,statsState.endTime=Date.now(),updateStats(),document.querySelectorAll(".loading-row").forEach((t=>{t.classList.remove("loading-row")}))}}function updateRow(t,e,r,n){t.classList.remove("loading-row"),t.innerHTML=`\n        <td>${e}</td>\n        <td><a href="${r}" target="_blank">${r}</a></td>\n        <td>${n.type}</td>\n        <td>${n.id}</td>\n        <td>${n.cmsLink.includes("http")?`<a href="${n.cmsLink}" target="_blank">${n.cmsLink}</a>`:n.cmsLink}</td>\n        <td>${n.level1}</td>\n        <td>${n.level2}</td>\n        <td>${n.level3}</td>\n        <td>${n.level4}</td>\n        <td>${n.level5}</td>\n        <td>${n.shortlink.includes("http")?`<a href="${n.shortlink}" target="_blank">${n.shortlink}</a>`:n.shortlink}</td>\n        <td>${n.title}</td>\n        <td>${n.metaDescription}</td>\n    `,("Lỗi"===n.id||n.shortlink.includes("Lỗi"))&&(t.classList.add("error"),appState.errorUrls.includes(r)||appState.errorUrls.push(r),updateButtonStates())}document.addEventListener("DOMContentLoaded",(()=>{toggleButtons.init(),document.getElementById("copyTableBtn").onclick=copyTable,document.getElementById("exportCsvBtn").onclick=exportCSV,document.getElementById("retryError").onclick=retryErrorUrls,document.getElementById("clear").onclick=clearData,document.addEventListener("keydown",(t=>{!t.ctrlKey&&!t.metaKey||"v"!==t.key||document.getElementById("urlInput").value||pasteFromClipboard(),(t.ctrlKey||t.metaKey)&&"Enter"===t.key&&processUrls()}))}));const HOME_KEYWORDS=["Home","Trang chủ","/"],MAX_LEVELS=5;function extractBreadcrumbCategories(t){const e=Object.fromEntries(Array.from({length:MAX_LEVELS},((t,e)=>[`level${e+1}`,""])));return assignCategories(extractBreadcrumbItems(t),e),e}function extractBreadcrumbItems(t){const e=[extractFromJsonLD,extractFromSchemaOrg,extractFromRankMath,extractFromWooCommerce,extractFromClearfix,extractFromSimpleContainer,extractFromSimpleBreadcrumb];for(const r of e){const e=r(t);if(e.length>0)return normalizeItems(e)}return[]}function extractFromJsonLD(t){const e=Array.from(t.querySelectorAll('script[type="application/ld+json"]'));for(const t of e)try{const e=JSON.parse(t.textContent);if("BreadcrumbList"===e["@type"]&&Array.isArray(e.itemListElement)){const t=e.itemListElement.map((t=>t.name||t.item&&t.item.name||"")).filter((t=>t&&!HOME_KEYWORDS.includes(t)));if(t.length>0)return t}}catch(t){console.warn("Error parsing JSON-LD:",t)}return[]}function extractFromSchemaOrg(t){const e=[],r=t.querySelectorAll('[itemtype*="schema.org/BreadcrumbList"]');for(const t of r){const r=Array.from(t.children).filter((t=>"li"===t.tagName.toLowerCase()&&!t.classList.contains("home")));for(const t of r){const r=t.querySelectorAll('[itemprop="itemListElement"]');if(r.length>0){for(const t of r){const r=t.querySelector('[itemprop="name"]');r&&addValidItem(e,r.textContent)}continue}const n=t.querySelector('[itemprop="name"]');n?addValidItem(e,n.textContent):addValidItem(e,t.textContent.replace(/[,\/>]/g,""))}if(e.length>0)return e}return[]}function extractFromRankMath(t){const e=t.querySelector(".rank-math-breadcrumb");if(!e)return[];return["a","span.last"].flatMap((t=>Array.from(e.querySelectorAll(t)).map((t=>t.textContent.trim())).filter((t=>t&&!HOME_KEYWORDS.includes(t)))))}function extractFromSimpleBreadcrumb(t){const e=t.querySelector("nav.breadcrumb");if(!e)return[];const r=Array.from(e.querySelectorAll("a")).map((t=>t.textContent.trim())).filter((t=>t&&!HOME_KEYWORDS.includes(t)));if(0===r.length){const t=e.textContent.trim();if(t)return t.split(/[>\/\\\|→]/).map((t=>t.trim())).filter((t=>t&&!HOME_KEYWORDS.includes(t)&&!/^[\/,\s]+$/.test(t)))}return r}function extractFromWooCommerce(t){const e=t.querySelector(".woocommerce-breadcrumb");return e?Array.from(e.childNodes).map((t=>1===t.nodeType&&"a"===t.tagName.toLowerCase()||3===t.nodeType?t.textContent.trim():"")).filter(Boolean):[]}function extractFromClearfix(t){const e=t.querySelector(".ty-breadcrumbs");return e?Array.from(e.querySelectorAll('.ty-breadcrumbs__a [itemprop="name"]')).map((t=>t.textContent.trim())):[]}function extractFromSimpleContainer(t){const e=t.querySelector(".main-breadc");return e?Array.from(e.childNodes).map((t=>t.textContent.trim())).filter(Boolean):[]}function addValidItem(t,e){const r=e.replace(/\s+/g," ").trim();!r||HOME_KEYWORDS.includes(r)||/^[\/,\s]+$/.test(r)||t.push(r)}function normalizeItems(t){return t.map((t=>t.replace(/\s+/g," ").trim())).filter(((t,e,r)=>r.indexOf(t)===e&&""!==t&&!HOME_KEYWORDS.includes(t)&&!/^[\/,\s]+$/.test(t)))}function assignCategories(t,e){t.slice(0,MAX_LEVELS).forEach(((t,r)=>{e[`level${r+1}`]=t}))}