const HOME_KEYWORDS=["Home","Trang chủ","/"],MAX_LEVELS=5,appState={hasData:!1,isProcessing:!1,successUrls:[],errorUrls:[],currentProxy:0,proxyList:["https://api.allorigins.win/raw?url=","https://api.codetabs.com/v1/proxy?quest="]},statsState={startTime:0,endTime:0,totalUrls:0,processedUrls:0},errorResult={type:"Lỗi kết nối",id:"",cmsLink:"",title:"Lỗi kết nối",metaDescription:"Lỗi kết nối",shortlink:"",level1:"",level2:"",level3:"",level4:"",level5:""},toast={container:null,queue:[],timeoutId:null,init(){this.container||(this.container=document.createElement("div"),this.container.className="toast-container",document.body.appendChild(this.container))},show(t,e="info",r=3500){this.init();const o=document.createElement("div");o.className=`toast toast-${e}`,o.textContent=t,this.queue.push({el:o,duration:r}),this.timeoutId||this._processQueue()},_processQueue(){if(!this.queue.length)return this.timeoutId=null;const{el:t,duration:e}=this.queue.shift();this.container.appendChild(t),setTimeout((()=>t.classList.add("show")),10),this.timeoutId=setTimeout((()=>{t.classList.remove("show"),setTimeout((()=>{t.remove(),this._processQueue()}),300)}),e)}},formatTime=t=>{if(t<60)return`${Math.floor(t)} giây`;const e=Math.floor(t/86400);t%=86400;const r=Math.floor(t/3600);t%=3600;const o=Math.floor(t/60);return`${e?e+" ngày ":""}${r?r+" giờ ":""}${o?o+" phút ":""}${t=Math.floor(t%60)} giây`},updateStats=()=>{const t=statsState.startTime?(Date.now()-statsState.startTime)/1e3:0,e=statsState.processedUrls?Math.ceil(statsState.processedUrls/t):0;document.querySelector(".detail-handle .progress").textContent=`${statsState.processedUrls}/${statsState.totalUrls}`,document.querySelector(".detail-handle .cout").textContent=statsState.totalUrls,document.querySelector(".detail-handle .time").textContent=formatTime(t),document.querySelector(".detail-handle .average-spend").textContent=e,document.querySelector(".detail-handle .err").textContent=appState.errorUrls.length},updateButtons=()=>{const t=document.getElementById("urlInput");document.getElementById("pasteButton").style.display=t.value.trim()?"none":"block";const e=appState.hasData;["copyTableBtn","exportCsvBtn","clear"].forEach((t=>document.getElementById(t).style.display=e?"block":"none")),document.getElementById("retryError").style.display=e&&appState.errorUrls.length?"block":"none"},validateAndProcessInput=t=>t.split("\n").map((t=>t.trim())).filter((t=>/^(https?:\/\/\S+)/.test(t)));async function pasteFromClipboard(){try{const e=await navigator.clipboard.readText();document.getElementById("urlInput").value=(t=e,t.split("\n").map((t=>t.trim())).filter((t=>/^(https?:\/\/\S+)/.test(t)))).join("\n"),updateButtons()}catch(t){toast.show(`Không thể dán: ${t}`,"error")}var t}const copyColumn=t=>{const e=[...document.getElementById("resultTable").rows].slice(1).map((e=>e.cells[t].textContent.trim())).join("\n");navigator.clipboard.writeText(e).then((()=>{const e=document.querySelector(`#resultTable thead tr th:nth-child(${t+1}) button`),r={text:e.textContent,style:e.style.cssText};e.textContent="Copied!",e.style.backgroundColor="#90EE90",e.style.borderColor="#4CAF50",setTimeout((()=>{e.textContent=r.text,e.style.cssText=r.style}),1e3)})).catch((t=>toast.show(`Không thể copy: ${t}`,"error")))},updateTableHeaders=()=>{const t=document.querySelector("#resultTable thead tr");if(!appState.hasData||t.querySelector("button"))return;const e=[...document.querySelectorAll("#resultTable tbody tr")];[...t.cells].forEach(((t,r)=>{if(e.some((t=>{const e=t.cells[r].textContent.trim();return e&&!["Lỗi","Không xác định","Không thể tạo link CMS"].includes(e)}))){const e=document.createElement("button");e.textContent="Copy",e.style.cssText="margin-left:.5rem;cursor:pointer;background:#f0f0f0;border:1px solid #ddd;border-radius:3px;padding:2px 6px;font-size:12px;opacity:0.8;transition:all 0.2s",e.onmouseover=()=>{e.style.opacity="1",e.style.backgroundColor="#e0e0e0"},e.onmouseout=()=>{e.style.opacity="0.8",e.style.backgroundColor="#f0f0f0"},e.onclick=t=>{t.stopPropagation(),copyColumn(r)},t.appendChild(e)}}))},getCleanHeaderText=t=>{const e=t.cloneNode(!0),r=e.querySelector("button");return r&&r.remove(),e.textContent.trim()},copyTable=()=>{const t=[...document.getElementById("resultTable").rows].map((t=>[...t.cells].map((t=>t.querySelector("button")?getCleanHeaderText(t):t.textContent.trim())).join("\t"))).join("\n");navigator.clipboard.writeText(t).then((()=>{const t=document.querySelector("#resultTable tbody");t.style.backgroundColor="#61ff5540",setTimeout((()=>t.style.backgroundColor=""),700)}))},encodeToUTF8=t=>(new TextEncoder).encode("\ufeff"+t),exportCSV=()=>{const t=[...document.getElementById("resultTable").rows],e=[...t[0].cells].map((t=>getCleanHeaderText(t))),r=t.slice(1).map((t=>[...t.cells].map((t=>`"${t.textContent.trim().replace(/"/g,'""')}"`)))),o=[e.join(","),...r.map((t=>t.join(",")))].join("\n"),a=new Blob([(n=o,(new TextEncoder).encode("\ufeff"+n))],{type:"text/csv;charset=utf-8"});var n;const s=document.createElement("a");s.href=URL.createObjectURL(a),s.download="url-info-export.csv",s.click()},timeoutPromise=(t,e=3e4)=>Promise.race([t,new Promise(((t,r)=>setTimeout((()=>r(new Error("Request timeout"))),e)))]);async function getUrlInfo(t,e=0){if(urlCache.has(t))return urlCache.get(t);const r=appState.proxyList[appState.currentProxy]+encodeURIComponent(t);try{const e=await timeoutPromise(fetch(r));if(!e.ok)throw new Error(`HTTP error ${e.status}`);const o=await e.text(),a=(new DOMParser).parseFromString(o,"text/html"),n=getIdAndTypeFromBodyClass(a.body.getAttribute("class")||"")||getIdAndTypeFromJsonLink(a)||getIdFromPageItem(a)||{id:"",type:""},s=extractBreadcrumbCategories(n.type,a),l={shortlink:getShortlink(a,t,n.id,n.type),id:n.id,type:n.type,title:a.querySelector("title")?.textContent||"",metaDescription:a.querySelector('meta[name="description"]')?.getAttribute("content")||"",cmsLink:getCmsLink(t,n.id,n.type),...s};appState.successUrls.includes(t)||appState.successUrls.push(t);const c=appState.errorUrls.indexOf(t);return c>-1&&appState.errorUrls.splice(c,1),urlCache.set(t,l),l}catch(r){return e<2?(appState.currentProxy=(appState.currentProxy+1)%appState.proxyList.length,await new Promise((t=>setTimeout(t,1e3*(e+1)))),getUrlInfo(t,e+1)):(appState.errorUrls.includes(t)||appState.errorUrls.push(t),urlCache.set(t,errorResult),errorResult)}}async function processUrls(){if(appState.isProcessing)return toast.show("Đang xử lý, vui lòng đợi...","warning");const t=document.getElementById("urlInput").value.split("\n").map((t=>t.trim())).filter(Boolean);if(!t.length)return toast.show("Vui lòng nhập ít nhất một URL","warning");statsState.startTime=Date.now(),statsState.totalUrls=t.length,statsState.processedUrls=0,updateStats(),appState.isProcessing=!0;const e=document.querySelector("#resultTable tbody");e.innerHTML="",appState.successUrls=[],appState.errorUrls=[],appState.currentProxy=0;const r=t.map(((t,r)=>{const o=document.createElement("tr");return o.className="loading-row",o.innerHTML=`<td>${r+1}</td>\n      <td><a href="${t}" target="_blank">${t}</a></td>\n      <td colspan="11"><div class="loading">Đang xử lý...</div></td>`,e.appendChild(o),o}));await Promise.all(t.map(((t,e)=>getUrlInfo(t).then((o=>{updateRow(r[e],e+1,t,o),statsState.processedUrls++,updateStats()})).catch((()=>{updateRow(r[e],e+1,t,errorResult),statsState.processedUrls++,updateStats()}))))),appState.hasData=!0,updateButtons(),updateTableHeaders(),checkForErrors(),appState.isProcessing=!1,statsState.endTime=Date.now(),updateStats(),r.forEach((t=>t.classList.remove("loading-row")))}function updateRow(t,e,r,o){t.classList.remove("loading-row"),t.innerHTML=`<td>${e}</td>\n    <td><a href="${r}" target="_blank">${r}</a></td>\n    <td>${o.type}</td>\n    <td>${o.id}</td>\n    <td>${o.cmsLink.startsWith("http")?`<a href="${o.cmsLink}" target="_blank">${o.cmsLink}</a>`:o.cmsLink}</td>\n    <td>${o.level1||""}</td>\n    <td>${o.level2||""}</td>\n    <td>${o.level3||""}</td>\n    <td>${o.level4||""}</td>\n    <td>${o.level5||""}</td>\n    <td>${o.shortlink.startsWith("http")?`<a href="${o.shortlink}" target="_blank">${o.shortlink}</a>`:o.shortlink}</td>\n    <td>${o.title}</td>\n    <td>${o.metaDescription}</td>`,o.id||(t.classList.add("error"),appState.errorUrls.includes(r)||appState.errorUrls.push(r),updateButtons())}async function retryErrorUrls(){if(appState.isProcessing)return toast.show("Đang xử lý, vui lòng đợi...","warning");if(!appState.errorUrls.length)return toast.show("Không có URL lỗi để thử lại","info");appState.errorUrls.forEach((t=>urlCache.delete(t))),statsState.startTime=Date.now(),statsState.totalUrls=appState.errorUrls.length,statsState.processedUrls=0,updateStats(),appState.isProcessing=!0,appState.currentProxy=(appState.currentProxy+1)%appState.proxyList.length;const t=[...document.querySelector("#resultTable tbody").querySelectorAll("tr.error")];t.forEach((t=>{t.classList.add("loading-row");const e=t.cells[1].querySelector("a").href;t.innerHTML=`<td>${t.cells[0].textContent}</td>\n      <td><a href="${e}" target="_blank">${e}</a></td>\n      <td colspan="11"><div class="loading">Đang xử lý...</div></td>`}));const e=[...appState.errorUrls];appState.errorUrls=[],toast.show(`Bắt đầu thử lại ${e.length} URL lỗi...`,"info"),await Promise.all(t.map(((t,r)=>getUrlInfo(e[r]).then((o=>{updateRow(t,t.cells[0].textContent,e[r],o),o.id&&(t.classList.remove("error"),t.classList.add("retry-success","success-animation"),setTimeout((()=>t.classList.remove("success-animation")),1e3))})).catch((()=>{updateRow(t,t.cells[0].textContent,e[r],{...errorResult,type:"Lỗi thử lại"}),t.classList.add("error"),appState.errorUrls.includes(e[r])||appState.errorUrls.push(e[r])})).finally((()=>{statsState.processedUrls++,updateStats()}))))),appState.isProcessing=!1,statsState.endTime=Date.now(),updateStats(),updateButtons(),toast.show(0===appState.errorUrls.length?"Đã xử lý lại thành công tất cả URL!":`Đã xử lý lại xong. Còn ${appState.errorUrls.length} URL bị lỗi.`,0===appState.errorUrls.length?"success":"warning")}function clearData(){document.getElementById("urlInput").value="",document.querySelector("#resultTable tbody").innerHTML="",Object.assign(appState,{hasData:!1,successUrls:[],errorUrls:[],currentProxy:0}),Object.assign(statsState,{startTime:0,endTime:0,totalUrls:0,processedUrls:0}),updateStats(),updateButtons(),urlCache.clear(),toast.show("Đã làm mới dữ liệu","success")}const checkForErrors=()=>{appState.errorUrls=[...document.querySelectorAll("#resultTable tbody tr.error")].map((t=>t.querySelector("td:nth-child(2) a").href)),updateButtons()};function getIdAndTypeFromBodyClass(t){const e=t.match(/(?:postid|page-id|term|category)-(\d+)/);if(!e)return null;let r="unknown";return t.includes("single-product")?r="product":t.includes("single-post")||t.includes("postid-")?r="post":t.includes("page-template")||t.includes("page-")?r="page":t.includes("tax-product_cat")?r="product_cat":(t.includes("category")||t.includes("post-type-archive"))&&(r="category"),{id:e[1],type:r}}function getIdAndTypeFromJsonLink(t){const e=t.querySelector('link[rel="alternate"][title="JSON"][type="application/json"]')?.getAttribute("href"),r=e&&e.match(/\/(categories|tags)\/(\d+)/);return r?{id:r[2],type:"categories"===r[1]?"category":"tag"}:null}function getIdFromPageItem(t){const e=t.querySelector('[class*="page-item-"]');if(!e)return null;const r=e.getAttribute("class").split(" ").find((t=>t.startsWith("page-item-")));return r?{id:r.replace("page-item-",""),type:"page"}:null}function getShortlink(t,e,r,o){let a=t.querySelector('link[rel="shortlink"]')?.getAttribute("href");return!a&&r&&["post","page","product"].includes(o)&&(a=`${new URL(e).origin}/?p=${r}`),a||""}function getCmsLink(t,e,r){if(!e||"Không xác định"===e||"Lỗi"===e)return"";const o=new URL(t).origin;switch(r){case"page":case"post":case"product":return`${o}/wp-admin/post.php?post=${e}&action=edit`;case"product_cat":return`${o}/wp-admin/term.php?taxonomy=product_cat&tag_ID=${e}&post_type=product`;case"category":return`${o}/wp-admin/term.php?taxonomy=category&tag_ID=${e}&post_type=post`;default:return""}}function extractBreadcrumbCategories(t,e){const r=Object.fromEntries([...Array(MAX_LEVELS)].map(((t,e)=>[`level${e+1}`,""])));if("page"===t)return r;const o=e.querySelector("h1")?.textContent.trim()||e.querySelector("h2")?.textContent.trim()||e.querySelector("title")?.textContent.trim()||"",a=normalizeItems(extractBreadcrumbItems(e));return assignCategories(a,r,o),r}const extractBreadcrumbItems=t=>{const e=[t=>extractFromMarkup(t,".rank-math-breadcrumb",["a","span.last"]),t=>extractFromWooCommerce(t),t=>extractFromMarkup(t,".ty-breadcrumbs",['.ty-breadcrumbs__a [itemprop="name"]']),t=>extractFromMarkup(t,".main-breadc"),t=>extractFromMarkup(t,"nav.breadcrumb",["a"]),t=>extractFromEntryCategory(t),t=>extractFromJsonLD(t),t=>extractFromSchemaOrg(t)];for(let r of e){const e=r(t);if(e.length)return e}return[]},extractFromMarkup=(t,e,r=[])=>{const o=t.querySelector(e);return o?r.length?r.flatMap((t=>[...o.querySelectorAll(t)].map((t=>t.textContent.trim())).filter((t=>t&&!HOME_KEYWORDS.includes(t))))):[...o.childNodes].map((t=>1===t.nodeType&&"a"===t.tagName.toLowerCase()||3===t.nodeType?t.textContent.trim():"")).filter((t=>t&&!HOME_KEYWORDS.includes(t)&&!/^[\/,\s]+$/.test(t))):[]},extractFromEntryCategory=t=>{const e=t.querySelector("h6.entry-category");return e?[...e.querySelectorAll("a[rel='category tag']")].map((t=>t.textContent.trim())).filter((t=>t&&!HOME_KEYWORDS.includes(t))):[]},extractFromWooCommerce=t=>{const e=t.querySelector(".woocommerce-breadcrumb");return e?[...e.childNodes].map((t=>1===t.nodeType&&"a"===t.tagName.toLowerCase()||3===t.nodeType?t.textContent.trim():"")).filter(Boolean):[]},extractFromJsonLD=t=>{const e=[...t.querySelectorAll('script[type="application/ld+json"]')];for(let t of e)try{const e=JSON.parse(t.textContent),r=findBreadcrumbList(e);if(r?.itemListElement){const t=r.itemListElement.map((t=>t.name||t.item&&t.item.name||"")).filter((t=>t&&!HOME_KEYWORDS.includes(t)));if(t.length)return t}}catch(t){console.warn("JSON-LD parse error:",t)}return[]},findBreadcrumbList=t=>{if(!t)return null;if("BreadcrumbList"===t["@type"]&&Array.isArray(t.itemListElement))return t;if(Array.isArray(t))for(let e of t){const t=findBreadcrumbList(e);if(t)return t}if("object"==typeof t)for(let e in t){const r=findBreadcrumbList(t[e]);if(r)return r}return null},extractFromSchemaOrg=t=>{const e=[];return[...t.querySelectorAll('[itemtype*="schema.org/BreadcrumbList"]')].forEach((t=>{[...t.children].filter((t=>"li"===t.tagName.toLowerCase()&&!t.classList.contains("home"))).forEach((t=>{const r=t.querySelectorAll('[itemprop="itemListElement"] [itemprop="name"]');if(r.length)return void r.forEach((t=>addValidItem(e,t.textContent)));const o=t.querySelector('[itemprop="name"]');addValidItem(e,o?o.textContent:t.textContent.replace(/[,\/>]/g,""))}))})),e},addValidItem=(t,e)=>{const r=e.replace(/\s+/g," ").trim();!r||HOME_KEYWORDS.includes(r)||/^[\/,\s]+$/.test(r)||t.push(r)},normalizeItems=t=>t.map((t=>t.replace(/\s+/g," ").trim())).filter(((t,e,r)=>t&&r.indexOf(t)===e)),normalizeText=t=>t.trim().replace(/\s+/g," ").replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").toLowerCase(),assignCategories=(t,e,r)=>{const o=normalizeText(r),a=t.map((t=>({orig:t,norm:normalizeText(t)})));(a.length&&a[a.length-1].norm===o?a.slice(0,-1):a).slice(0,MAX_LEVELS).forEach(((t,r)=>{e[`level${r+1}`]=t.orig}))},urlCache=new Map;document.addEventListener("DOMContentLoaded",(()=>{updateButtons(),document.getElementById("copyTableBtn").onclick=copyTable,document.getElementById("exportCsvBtn").onclick=exportCSV,document.getElementById("retryError").onclick=retryErrorUrls,document.getElementById("clear").onclick=clearData,document.addEventListener("keydown",(t=>{!t.ctrlKey&&!t.metaKey||"v"!==t.key||document.getElementById("urlInput").value||pasteFromClipboard(),(t.ctrlKey||t.metaKey)&&"Enter"===t.key&&processUrls()}))}));